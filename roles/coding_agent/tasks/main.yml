- name: Ensure .claude directory exists
  file:
    path: ~/.claude
    state: directory
    mode: '0755'

- name: Check if CLAUDE.md exists
  stat:
    path: ~/.claude/CLAUDE.md
  register: coding_agent_claude_md_stat

# TODO: it does not work if we run this role for a different host
- name: Check file differences for CLAUDE.md
  command: diff ~/.claude/CLAUDE.md "{{ role_path }}/files/AGENTS.md"
  register: coding_agent_claude_md_diff
  failed_when: false
  changed_when: false
  when: coding_agent_claude_md_stat.stat.exists and not coding_agent_claude_md_stat.stat.islnk

- name: Remove existing CLAUDE.md if identical to target
  file:
    path: ~/.claude/CLAUDE.md
    state: absent
  when:
    - coding_agent_claude_md_stat.stat.exists
    - not coding_agent_claude_md_stat.stat.islnk
    - coding_agent_claude_md_diff.rc == 0

- name: Create symlink for CLAUDE.md
  file:
    src: "{{ role_path }}/files/AGENTS.md"
    dest: ~/.claude/CLAUDE.md
    state: link

- name: Ensure .gemini directory exists
  file:
    path: ~/.gemini
    state: directory
    mode: '0755'

- name: Check if GEMINI.md exists
  stat:
    path: ~/.gemini/GEMINI.md
  register: coding_agent_gemini_md_stat

# TODO: it does not work if we run this role for a different host
- name: Check file differences for GEMINI.md
  command: diff ~/.gemini/GEMINI.md "{{ role_path }}/files/AGENTS.md"
  register: coding_agent_gemini_md_diff
  failed_when: false
  changed_when: false
  when: coding_agent_gemini_md_stat.stat.exists and not coding_agent_gemini_md_stat.stat.islnk

- name: Remove existing GEMINI.md if identical to target
  file:
    path: ~/.gemini/GEMINI.md
    state: absent
  when:
    - coding_agent_gemini_md_stat.stat.exists
    - not coding_agent_gemini_md_stat.stat.islnk
    - coding_agent_gemini_md_diff.rc == 0

- name: Create symlink for GEMINI.md
  file:
    src: "{{ role_path }}/files/AGENTS.md"
    dest: ~/.gemini/GEMINI.md
    state: link

- name: Ensure .claude/commands directory exists
  file:
    path: ~/.claude/commands
    state: directory
    mode: '0755'

- name: Generate create-pr.md for Claude
  template:
    src: create-pr.md.j2
    dest: ~/.claude/commands/create-pr.md
    mode: '0644'

- name: Ensure .gemini/commands directory exists
  file:
    path: ~/.gemini/commands
    state: directory
    mode: '0755'

- name: Read create-pr.md content
  set_fact:
    coding_agent_create_pr_md_content: "{{ lookup('template', 'create-pr.md.j2') }}"

- name: Generate create-pr.toml for Gemini
  template:
    src: create-pr.toml.j2
    dest: ~/.gemini/commands/create-pr.toml
    mode: '0644'

- name: Remove incorrect create-pr.md for Gemini
  file:
    path: ~/.gemini/commands/create-pr.md
    state: absent

- name: Install Claude Code via mise
  command: mise use -g claude
  environment:
    PATH: "{{ ansible_env.HOME }}/.local/share/mise/shims:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
  retries: 3
  delay: 5
  register: coding_agent_claude_install_result
  until: coding_agent_claude_install_result.rc == 0

- name: Install Gemini CLI via mise
  command: mise use -g gemini
  environment:
    PATH: "{{ ansible_env.HOME }}/.local/share/mise/shims:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
  retries: 3
  delay: 5
  register: coding_agent_gemini_install_result
  until: coding_agent_gemini_install_result.rc == 0

# Explicitly set PATH because the Ansible non-interactive shell might not
# include paths for tools installed via mise (e.g., ~/.local/share/mise/shims).
- name: Check if playwright MCP is registered in Claude
  shell: |
    export PATH="{{ ansible_env.HOME }}/.local/share/mise/shims:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
    claude mcp list | grep playwright
  register: coding_agent_claude_mcp_list
  failed_when: false
  changed_when: false

- name: Register playwright MCP to Claude
  command: claude mcp add playwright npx @playwright/mcp@latest -s user
  environment:
    # Use explicit PATH to ensure 'claude' and 'npx' are found in the Ansible environment.
    PATH: "{{ ansible_env.HOME }}/.local/share/mise/shims:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
  when: coding_agent_claude_mcp_list.rc != 0

- name: Check if playwright MCP is registered in Gemini
  shell: |
    export PATH="{{ ansible_env.HOME }}/.local/share/mise/shims:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
    gemini mcp list | grep playwright
  register: coding_agent_gemini_mcp_list
  failed_when: false
  changed_when: false

- name: Register playwright MCP to Gemini
  command: gemini mcp add playwright npx @playwright/mcp@latest -s user
  environment:
    # Use explicit PATH to ensure 'gemini' and 'npx' are found in the Ansible environment.
    PATH: "{{ ansible_env.HOME }}/.local/share/mise/shims:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
  when: coding_agent_gemini_mcp_list.rc != 0
