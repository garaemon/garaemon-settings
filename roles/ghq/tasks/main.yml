# TODO: Remove this role once ghq_settings_root dependency from other roles is resolved.
# ghq package itself is already managed by home.nix.
- name: Check if ghq is already installed
  command: which ghq
  register: ghq_check
  ignore_errors: true
  changed_when: false

- name: Install ghq via mise
  command: mise install ghq@{{ ghq_version }}
  environment:
    PATH: "{{ ansible_facts.env.HOME }}/.local/bin:{{ ansible_facts.env.PATH }}"
  when: ghq_check.rc != 0

- name: Set ghq as global version in mise
  command: mise global ghq@{{ ghq_version }}
  environment:
    PATH: "{{ ansible_facts.env.HOME }}/.local/bin:{{ ansible_facts.env.PATH }}"
  when: ghq_check.rc != 0

- name: Get ghq root directory
  shell: |
    eval "$({{ ansible_facts.env.HOME }}/.local/bin/mise activate bash)"
    ghq root
  args:
    executable: /bin/bash
  register: ghq_root_result
  changed_when: false
  failed_when: false

- name: Set ghq root path as global variable
  set_fact:
    ghq_root_path: "{{ ghq_root_result.stdout if ghq_root_result.rc == 0 else ansible_facts.env.HOME + '/ghq' }}"

- name: Detect CI environment
  set_fact:
    ghq_is_ci: "{{ lookup('env', 'CI') != '' or lookup('env', 'GITHUB_ACTIONS') != '' }}"

- name: Set settings root path
  set_fact:
    ghq_settings_root: "{{ playbook_dir if ghq_is_ci else ghq_root_path + '/github.com/garaemon/garaemon-settings' }}"
