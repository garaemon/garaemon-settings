- name: Install Ghostty on Debian/Ubuntu
  when: ansible_os_family == 'Debian'
  block:
    - name: Check if ghostty is already installed
      command: which ghostty
      register: ghostty_installed
      ignore_errors: true
      changed_when: false

    - name: Install ghostty from deb file
      when: ghostty_installed.rc != 0
      block:
        - name: Create temporary directory for ghostty download
          tempfile:
            state: directory
            suffix: ghostty
          register: ghostty_temp_dir

        - name: Get latest ghostty-ubuntu release tag
          uri:
            url: https://api.github.com/repos/mkasberg/ghostty-ubuntu/releases/latest
            return_content: true
          register: ghostty_release
          changed_when: false

        - name: Set ghostty version and architecture variables
          set_fact:
            ghostty_tag: "{{ ghostty_release.json.tag_name }}"
            ghostty_version: >-
              {{ ghostty_release.json.tag_name |
                 regex_replace('^([0-9.]+)-([0-9]+)-ppa([0-9]+)$', '\\1-\\2.ppa\\3') }}
            ghostty_arch: "{{ 'amd64' if ansible_architecture == 'x86_64' else 'arm64' }}"
            ghostty_distro_version: "{{ ansible_distribution_version }}"

        - name: Set ghostty download URL
          set_fact:
            ghostty_deb_filename: >-
              ghostty_{{ ghostty_version }}_{{ ghostty_arch }}_{{ ghostty_distro_version }}.deb
            ghostty_download_url: >-
              https://github.com/mkasberg/ghostty-ubuntu/releases/download/{{
              ghostty_tag }}/ghostty_{{ ghostty_version }}_{{
              ghostty_arch }}_{{ ghostty_distro_version }}.deb

        - name: Download ghostty deb file
          get_url:
            url: "{{ ghostty_download_url }}"
            dest: "{{ ghostty_temp_dir.path }}/ghostty.deb"
            mode: "0644"

        - name: Install ghostty deb package
          apt:
            deb: "{{ ghostty_temp_dir.path }}/ghostty.deb"
            state: present
          become: true

        - name: Clean up temporary directory
          file:
            path: "{{ ghostty_temp_dir.path }}"
            state: absent

    - name: Make directory for ghostty config
      file:
        path: "{{ ansible_env.HOME }}/.config/ghostty"
        state: directory
        mode: "0755"

    - name: Check if ghostty config exists
      stat:
        path: "{{ ansible_env.HOME }}/.config/ghostty/config"
      register: ghostty_config_stat_debian

    - name: Check file differences for ghostty config
      command: diff "{{ ansible_env.HOME }}/.config/ghostty/config" ~/gprog/garaemon-settings/roles/ghostty/files/config
      register: ghostty_config_diff_debian
      failed_when: false
      changed_when: false
      when: ghostty_config_stat_debian.stat.exists and not ghostty_config_stat_debian.stat.islnk

    - name: Remove existing ghostty config if identical to target
      file:
        path: "{{ ansible_env.HOME }}/.config/ghostty/config"
        state: absent
      when:
        - ghostty_config_stat_debian.stat.exists
        - not ghostty_config_stat_debian.stat.islnk
        - ghostty_config_diff_debian.rc == 0

    - name: Create symlink for ghostty config
      file:
        src: ~/gprog/garaemon-settings/roles/ghostty/files/config
        dest: "{{ ansible_env.HOME }}/.config/ghostty/config"
        state: link

- name: Configure Ghostty on Darwin
  when: ansible_os_family == 'Darwin'
  block:

    - name: Make directory for config
      file:
        path: "{{ ansible_env.HOME }}/Library/Application Support/com.mitchellh.ghostty"
        state: directory
        mode: "0755"

    - name: Check if ghostty config exists
      stat:
        path: "{{ ansible_env.HOME }}/Library/Application Support/com.mitchellh.ghostty/config"
      register: ghostty_config_stat

    - name: Check file differences for ghostty config
      command: diff "{{ ansible_env.HOME }}/Library/Application Support/com.mitchellh.ghostty/config" ~/gprog/garaemon-settings/roles/ghostty/files/config
      register: ghostty_config_diff
      failed_when: false
      changed_when: false
      when: ghostty_config_stat.stat.exists and not ghostty_config_stat.stat.islnk

    - name: Remove existing ghostty config if identical to target
      file:
        path: "{{ ansible_env.HOME }}/Library/Application Support/com.mitchellh.ghostty/config"
        state: absent
      when:
        - ghostty_config_stat.stat.exists
        - not ghostty_config_stat.stat.islnk
        - ghostty_config_diff.rc == 0

    - name: Create symlink for ghostty config
      file:
        src: ~/gprog/garaemon-settings/roles/ghostty/files/config
        dest: "{{ ansible_env.HOME }}/Library/Application Support/com.mitchellh.ghostty/config"
        state: link
