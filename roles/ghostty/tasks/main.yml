- name: Get ghq root directory
  command: ghq root
  register: ghostty_ghq_root
  changed_when: false
  failed_when: false

- name: Set ghq root path
  set_fact:
    ghostty_ghq_root_path: "{{ ghostty_ghq_root.stdout if ghostty_ghq_root.rc == 0 else ansible_env.HOME + '/ghq' }}"

- name: Configure Ghostty on Debian/Ubuntu
  when: ansible_os_family == 'Debian'
  block:
    - name: Make directory for ghostty config
      file:
        path: "{{ ansible_env.HOME }}/.config/ghostty"
        state: directory
        mode: "0755"

    - name: Check if ghostty config exists
      stat:
        path: "{{ ansible_env.HOME }}/.config/ghostty/config"
      register: ghostty_config_stat_debian

    - name: Check file differences for ghostty config
      command: >
        diff "{{ ansible_env.HOME }}/.config/ghostty/config"
        "{{ ghostty_ghq_root_path }}/github.com/garaemon/garaemon-settings/roles/ghostty/files/config"
      register: ghostty_config_diff_debian
      failed_when: false
      changed_when: false
      when: ghostty_config_stat_debian.stat.exists and not ghostty_config_stat_debian.stat.islnk

    - name: Remove existing ghostty config if identical to target
      file:
        path: "{{ ansible_env.HOME }}/.config/ghostty/config"
        state: absent
      when:
        - ghostty_config_stat_debian.stat.exists
        - not ghostty_config_stat_debian.stat.islnk
        - ghostty_config_diff_debian.rc == 0

    - name: Create symlink for ghostty config
      file:
        src: "{{ ghostty_ghq_root_path }}/github.com/garaemon/garaemon-settings/roles/ghostty/files/config"
        dest: "{{ ansible_env.HOME }}/.config/ghostty/config"
        state: link

- name: Configure Ghostty on Darwin
  when: ansible_os_family == 'Darwin'
  block:

    - name: Make directory for config
      file:
        path: "{{ ansible_env.HOME }}/Library/Application Support/com.mitchellh.ghostty"
        state: directory
        mode: "0755"

    - name: Check if ghostty config exists
      stat:
        path: "{{ ansible_env.HOME }}/Library/Application Support/com.mitchellh.ghostty/config"
      register: ghostty_config_stat

    - name: Check file differences for ghostty config
      command: >
        diff "{{ ansible_env.HOME }}/Library/Application Support/com.mitchellh.ghostty/config"
        "{{ ghostty_ghq_root_path }}/github.com/garaemon/garaemon-settings/roles/ghostty/files/config"
      register: ghostty_config_diff
      failed_when: false
      changed_when: false
      when: ghostty_config_stat.stat.exists and not ghostty_config_stat.stat.islnk

    - name: Remove existing ghostty config if identical to target
      file:
        path: "{{ ansible_env.HOME }}/Library/Application Support/com.mitchellh.ghostty/config"
        state: absent
      when:
        - ghostty_config_stat.stat.exists
        - not ghostty_config_stat.stat.islnk
        - ghostty_config_diff.rc == 0

    - name: Create symlink for ghostty config
      file:
        src: "{{ ghostty_ghq_root_path }}/github.com/garaemon/garaemon-settings/roles/ghostty/files/config"
        dest: "{{ ansible_env.HOME }}/Library/Application Support/com.mitchellh.ghostty/config"
        state: link
