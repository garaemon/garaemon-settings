- name: Get ghq root directory
  command: ghq root
  register: clang_format_ghq_root
  changed_when: false
  failed_when: false

- name: Set ghq root path
  set_fact:
    clang_format_ghq_root_path: "{{ clang_format_ghq_root.stdout if clang_format_ghq_root.rc == 0 else ansible_env.HOME + '/ghq' }}"

- name: Install clang-format
  apt:
    name:
      - clang-format
  become: true
  when: ansible_os_family == "Debian"

- name: Check if clang-format exists
  stat:
    path: ~/.clang-format
  register: clang_format_stat

- name: Check file differences for clang-format
  command: diff ~/.clang-format "{{ clang_format_ghq_root_path }}/github.com/garaemon/garaemon-settings/roles/clang_format/files/clang-format"
  register: clang_format_diff
  failed_when: false
  changed_when: false
  when: clang_format_stat.stat.exists and not clang_format_stat.stat.islnk

- name: Remove existing clang-format if identical to target
  file:
    path: ~/.clang-format
    state: absent
  when:
    - clang_format_stat.stat.exists
    - not clang_format_stat.stat.islnk
    - clang_format_diff.rc == 0

- name: Create symlink for clang-format
  file:
    src: "{{ clang_format_ghq_root_path }}/github.com/garaemon/garaemon-settings/roles/clang_format/files/clang-format"
    dest: ~/.clang-format
    state: link
