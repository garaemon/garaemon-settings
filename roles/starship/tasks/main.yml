- name: Remove old starship binary
  file:
    path: "{{ ansible_facts.env.HOME }}/.local/bin/starship"
    state: absent

- name: Install starship via mise
  command: mise use -g starship@{{ starship_version }}
  environment:
    PATH: "{{ ansible_facts.env.HOME }}/.local/bin:{{ ansible_facts.env.PATH }}"

- name: Create config directory
  file:
    path: '{{ ansible_facts.env.HOME }}/.config'
    state: directory

- name: Check if starship.toml exists
  stat:
    path: '{{ ansible_facts.env.HOME }}/.config/starship.toml'
  register: starship_toml_stat

- name: Check file differences for starship.toml
  command: >
    diff '{{ ansible_facts.env.HOME }}/.config/starship.toml'
    "{{ ghq_settings_root }}/roles/starship/files/starship.toml"
  register: starship_toml_diff
  failed_when: false
  changed_when: false
  when:
    - starship_toml_stat.stat.exists
    - not starship_toml_stat.stat.islnk

- name: Remove existing starship.toml if identical to target
  file:
    path: '{{ ansible_facts.env.HOME }}/.config/starship.toml'
    state: absent
  when:
    - starship_toml_stat.stat.exists
    - not starship_toml_stat.stat.islnk
    - starship_toml_diff.rc == 0

- name: Create symlink for starship.toml
  file:
    src: "{{ ghq_settings_root }}/roles/starship/files/starship.toml"
    dest: '{{ ansible_facts.env.HOME }}/.config/starship.toml'
    state: link
