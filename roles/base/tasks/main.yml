- name: Check if git is installed
  command: which git
  register: base_git_check
  ignore_errors: true
  changed_when: false

- name: Install git
  apt:
    name:
      - git
  become: true
  when:
    - ansible_os_family == "Debian"
    - base_git_check.rc != 0

- name: Create ~/gprog directory
  file:
    path: ~/gprog
    state: directory

- name: Get hostname
  command: hostname
  register: base_hostname
  changed_when: false

- name: Make temp directory to copy the remote public key
  delegate_to: localhost
  run_once: true
  ansible.builtin.tempfile:
    state: directory
  register: base_local_temp_directory_for_ssh_key

- name: Check if gh command exists
  command: which gh
  register: base_gh_exists
  ignore_errors: true
  changed_when: false

- name: Check if gh is authenticated
  command: gh auth status
  register: base_gh_auth_status
  ignore_errors: true
  changed_when: false
  when: base_gh_exists.rc == 0

- name: Remove github.com from known_hosts
  command: ssh-keygen -R github.com
  ignore_errors: true

- name: Create ~/.ssh directory
  file:
    path: ~/.ssh
    state: directory
    mode: 700

- name: Add github.com to known_hosts
  shell: ssh-keyscan -H github.com >> {{ ansible_env.HOME }}/.ssh/known_hosts

- name: Check if garaemon-settings repository exists
  stat:
    path: ~/gprog/garaemon-settings/.git
  register: base_repo_exists

- name: Get current branch of garaemon-settings
  git:
    repo: git@github.com:garaemon/garaemon-settings.git
    dest: ~/gprog/garaemon-settings
    update: false
  register: base_git_status
  ignore_errors: true
  changed_when: false
  when: base_repo_exists.stat.exists

- name: Test SSH connection to GitHub
  command: ssh -T git@github.com
  register: base_ssh_test
  ignore_errors: true
  changed_when: false

- name: Check if SSH authentication is working
  set_fact:
    base_ssh_auth_working: "{{ 'successfully authenticated' in base_ssh_test.stderr }}"

- name: Update garaemon-settings only if on master branch (SSH)
  git:
    repo: git@github.com:garaemon/garaemon-settings.git
    dest: ~/gprog/garaemon-settings
  when:
    - not base_repo_exists.stat.exists or (base_git_status is defined and base_git_status.after == "master")
    - base_ssh_auth_working | bool

- name: Update garaemon-settings only if on master branch (HTTPS)
  git:
    repo: https://github.com/garaemon/garaemon-settings.git
    dest: ~/gprog/garaemon-settings
  when:
    - not base_repo_exists.stat.exists or (base_git_status is defined and base_git_status.after == "master")
    - not (base_ssh_auth_working | bool)
